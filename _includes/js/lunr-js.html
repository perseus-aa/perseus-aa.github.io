{%- assign fields = site.data.config-search -%}
{%- assign index_fields = fields | where: 'index','true' -%}
<script src="{{ '/assets/lib/lunr.min.js' | relative_url }}"></script>
<script src="{{ '/assets/js/lunr-store.js' | relative_url }}"></script>
<script>
  const fields = [
    'title', 'caption', 'summary', 'context',
    'name', 'period', 'region', 'building_type', 'objtype', 'id'
  ];

  let idx;

  // Utility: Get ?q=... from URL
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
  }

  // Build and search after DOM loads
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM loaded");

    // Build the Lunr index
    idx = lunr(function () {
      this.ref('id');
      fields.forEach(f => this.field(f));
      store.forEach(doc => this.add(doc));
    });

    console.log("Lunr index built");

    // Hook up form submission
    const form = document.getElementById('lunrSearch');
    if (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        lunr_search();
      });
    }

    // Check if there's a query string ?q=
    const query = getQueryParam('q');
    if (query) {
      const input = document.getElementById('lunrSearchBox');
      if (input) {
        input.value = query;
        lunr_search();
      }
    }
  });

  // Main search function
  function lunr_search() {
    const query = document.getElementById('lunrSearchBox').value.trim();
    console.log("Search query:", query);

    const table = document.getElementById('lunrResults');
    if (!query || !idx) {
      table.innerHTML = '';
      return;
    }

    const results = idx.search(query);
    console.log("Search results:", results);

    renderTable(results);
  }

  // Render results into the table
  function renderTable(results) {
    const table = document.getElementById('lunrResults');
    table.innerHTML = '';

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    fields.forEach(field => {
      const th = document.createElement('th');
      th.textContent = field;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    results.forEach(result => {
      const doc = store.find(d => d.id === result.ref);
      if (!doc) return;

      const row = document.createElement('tr');
      fields.forEach(field => {
        const cell = document.createElement('td');
        const value = doc[field];
        if (field === 'id' && value) {
          cell.innerHTML = `<a href="${value}">${value}</a>`;
        } else {
          cell.textContent = value || '';
        }
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
  }
</script>
